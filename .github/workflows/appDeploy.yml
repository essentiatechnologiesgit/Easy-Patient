name: iOS Screenshot Upload Automation
on:
  push:
    branches:
      - development

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.x'

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.3

      - name: Install dependencies
        run: |
          gem install jwt
          pip install requests

      - name: Generate JWT
        id: generate_jwt
        run: |
          ISSUER_ID="ad39d400-3314-48f8-977c-29a272eebad0"
          KEY_ID="74H4QHFPVP"
          private_key="
          -----BEGIN PRIVATE KEY-----
          MIGTAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBHkwdwIBAQQgmtzyTVPL1cphRZjf
          pzIlE/6pV5OFCS6zaUoyqBIHflygCgYIKoZIzj0DAQehRANCAASQxfZ0NyqZre50
          6NGowYahQsvqEQew5MStUc94chxoi8QqtVNTOcsgzqflnQ/v7YeETnnUX+P+2+2E
          +EG+nw8t
          -----END PRIVATE KEY-----
          "

          token=$(ruby -rjwt -ropenssl -e "
            private_key_obj = OpenSSL::PKey::EC.new('$private_key')
            token = JWT.encode(
              {
                iss: '$ISSUER_ID',
                exp: Time.now.to_i + 20 * 60,
                aud: 'appstoreconnect-v1'
              },
              private_key_obj,
              'ES256',
              header_fields = {
                kid: '$KEY_ID'
              }
            )
            puts token
          ")
          
          echo "token=$token" >> $GITHUB_ENV

      - name: Calculate image checksum
        id: checksum
        run: |
          file_path="src/assets/Screenshots/04.png"
          checksum=$(shasum -a 256 "$file_path" | awk '{ print $1 }')
          echo "checksum=$checksum" >> $GITHUB_ENV

      # Other steps remain the same
      
      - name: Create Screenshot Set
        id: create_screenshot_set
        run: |
          response=$(curl -X POST \
            -H "Authorization: Bearer ${{ secrets.token }}" \
            -H "Content-Type: application/json" \
            -d '{
              "data": {
                "type": "appScreenshotSets",
                "attributes": {
                  "deviceType": "IPHONE_6_5_INCH"
                },
                "relationships": {
                  "appStoreVersion": {
                    "data": {
                      "id": "YOUR_APP_STORE_VERSION_ID",
                      "type": "appStoreVersions"
                    }
                  }
                }
              }
            }' \
            https://api.appstoreconnect.apple.com/v1/appScreenshotSets)
      
          echo "Create Screenshot Set Response: $response"
          screenshot_set_id=$(echo $response | jq -r '.data.id')
      
          if [ "$screenshot_set_id" == "null" ] || [ -z "$screenshot_set_id" ]; then
            echo "Failed to create screenshot set or invalid screenshot_set_id."
            exit 1
          fi
      
          echo "screenshot_set_id=$screenshot_set_id" >> $GITHUB_ENV
      
      - name: Upload Screenshot
        run: |
          response=$(curl -X POST \
            -H "Authorization: Bearer ${{ secrets.token }}" \
            -H "Content-Type: application/json" \
            -d '{
              "data": {
                "type": "appScreenshots",
                "attributes": {
                  "sourceFileChecksum": "${{ env.checksum }}",
                  "uploaded": false
                },
                "relationships": {
                  "appScreenshotSet": {
                    "data": {
                      "id": "${{ env.screenshot_set_id }}",
                      "type": "appScreenshotSets"
                    }
                  }
                }
              }
            }' \
            https://api.appstoreconnect.apple.com/v1/appScreenshots)
      
          echo "Upload Screenshot Response: $response"
          upload_url=$(echo $response | jq -r '.data.attributes.uploadOperations[0].url')
      
          if [ -z "$upload_url" ]; then
            echo "Failed to obtain upload URL."
            exit 1
          fi
      
          curl -X PUT \
            -H "Content-Type: image/png" \
            --data-binary "@src/assets/Screenshots/04.png" \
            "$upload_url"
